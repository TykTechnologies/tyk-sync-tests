name: Tyk Sync sync Command
description: This test suite checks if sync command works with Tyk Dashboard
testcases:
  - name: Clear all APIs and Policies
    steps:
      - info: "first dump existing Tyk Dashboard resources"
        script: |
          tyk-sync dump -d "{{ .TYK_URL }}" -s="{{ .TYK_AUTH }}" -t ../test
        assertions:
          - result.code MustEqual 0
      - info: "run clean-apis.sh to clean up resources on Tyk"
        script: |
          TYK_AUTH="{{.TYK_AUTH}}" TYK_URL="{{ .TYK_URL }}" ../clean-apis.sh
        assertions:
          - result.code MustEqual 0
  - name: Verify that no APIs and Policies exist on Dashboard
    steps:
      - info: "verify that no APIs left"
        type: http
        url: '{{ .TYK_URL }}/api/apis'
        headers:
          Content-Type: application/json
          Authorization: '{{ .TYK_AUTH }}'
        assertions:
          - result.bodyjson ShouldNotBeEmpty
          - result.bodyjson ShouldHaveLength 2
          - result.bodyjson ShouldContainKey apis
          - result.bodyjson ShouldContainKey pages
          - result.bodyjson.pages ShouldEqual 1
      - info: "verify that no Policy left"
        type: http
        url: '{{ .TYK_URL }}/api/portal/policies'
        headers:
          Content-Type: application/json
          Authorization: '{{ .TYK_AUTH }}'
        assertions:
          - result.bodyjson ShouldNotBeEmpty
          - result.bodyjson ShouldContainKey Data
          - result.bodyjson ShouldContainKey Pages

  - name: Check if sync command creates APIs and Policies
    steps:
      - info: "run sync command"
        type: exec
        name: Run exec command to sync APIs
        script: |
          tyk-sync sync -d "{{ .TYK_URL }}" -s="{{ .TYK_AUTH }}" -p ../test
          sleep 1;
      - info: "sync command must recreate all APIs"
        name: Fetch all APIs to confirm if they were created
        type: http
        method: GET
        url: '{{ .TYK_URL }}/api/apis'
        headers:
          Content-Type: application/json
          Authorization: '{{ .TYK_AUTH }}'
        retry: 3
        assertions:
          - result.bodyjson ShouldNotBeEmpty
          - result.bodyjson ShouldHaveLength 2
          - result.bodyjson ShouldContainKey apis
          - result.bodyjson ShouldContainKey pages
          - result.bodyjson.apis ShouldHaveLength 10
      - info: "sync command must recreate all Policies"
        name: Fetch all Policies to confirm if they were synced
        type: http
        method: GET
        url: '{{ .TYK_URL }}/api/portal/policies'
        headers:
          Content-Type: application/json
          Authorization: '{{ .TYK_AUTH }}'
        retry: 3
        assertions:
          - result.bodyjson ShouldNotBeEmpty
          - result.bodyjson ShouldHaveLength 2
          - result.bodyjson ShouldContainKey Data
          - result.bodyjson ShouldContainKey Pages
          - result.bodyjson.Data ShouldHaveLength 5

  - name: Check if sync command creates APIs and Policies
    steps:
      - info: "run sync command"
        type: exec
        name: Run exec command to sync APIs
        script: |
          tyk-sync sync -d "{{ .TYK_URL }}" -s="{{ .TYK_AUTH }}" -p ../test
          sleep 1;
      - info: "sync command must recreate all APIs"
        name: Fetch all APIs to confirm if they were created
        type: http
        method: GET
        url: '{{ .TYK_URL }}/api/apis'
        headers:
          Content-Type: application/json
          Authorization: '{{ .TYK_AUTH }}'
        retry: 3
        assertions:
          - result.bodyjson ShouldNotBeEmpty
          - result.bodyjson ShouldHaveLength 2
          - result.bodyjson ShouldContainKey apis
          - result.bodyjson ShouldContainKey pages
          - result.bodyjson.apis ShouldHaveLength 10
      - info: "sync command must recreate all Policies"
        name: Fetch all Policies to confirm if they were synced
        type: http
        method: GET
        url: '{{ .TYK_URL }}/api/portal/policies'
        headers:
          Content-Type: application/json
          Authorization: '{{ .TYK_AUTH }}'
        retry: 3
        assertions:
          - result.bodyjson ShouldNotBeEmpty
          - result.bodyjson ShouldHaveLength 2
          - result.bodyjson ShouldContainKey Data
          - result.bodyjson ShouldContainKey Pages
          - result.bodyjson.Data ShouldHaveLength 5

  - name: Check if sync command deletes APIs and Policies after using the --no--delete flag
    steps:
      - info: "remove api and policy items from json file"
        type: exec
        name: Run exec command to clean .tyk.json file
        script: |
          ../clear-tyk-json.sh
          sleep 1;
      - info: "run sync command"
        type: exec
        name: Run sync command with --no-delete flag
        script: |
          tyk-sync sync -d "{{ .TYK_URL }}" -s="{{ .TYK_AUTH }}" --no-delete -p ../test
          sleep 1;          
      - info: "sync command should not delete APIs"
        name: Fetch all APIs to confirm if they were not deleted on DB
        type: http
        method: GET
        url: '{{ .TYK_URL }}/api/apis'
        headers:
          Content-Type: application/json
          Authorization: '{{ .TYK_AUTH }}'
        retry: 3
        assertions:
          - result.bodyjson ShouldNotBeEmpty
          - result.bodyjson ShouldHaveLength 2
          - result.bodyjson ShouldContainKey apis
          - result.bodyjson ShouldContainKey pages
          - result.bodyjson.apis ShouldHaveLength 10
      - info: "sync command must not delete Policies"
        name: Fetch all Policies to confirm that they were not deleted on DB
        type: http
        method: GET
        url: '{{ .TYK_URL }}/api/portal/policies'
        headers:
          Content-Type: application/json
          Authorization: '{{ .TYK_AUTH }}'
        retry: 3
        assertions:
          - result.bodyjson ShouldNotBeEmpty
          - result.bodyjson ShouldHaveLength 2
          - result.bodyjson ShouldContainKey Data
          - result.bodyjson ShouldContainKey Pages
          - result.bodyjson.Data ShouldHaveLength 5                 
